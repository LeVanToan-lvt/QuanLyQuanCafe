#DanhGiaBinhLuan.aspx.cs
using System;
using System.Data;

public partial class DanhGiaBinhLuan : System.Web.UI.Page
{
    private DataTable BinhLuanTable
    {
        get
        {
            if (ViewState["BinhLuan"] == null)
            {
                DataTable dt = new DataTable();
                dt.Columns.Add("TenKhach");
                dt.Columns.Add("SoSao", typeof(int));
                dt.Columns.Add("NoiDung");
                dt.Columns.Add("Ngay", typeof(DateTime));
                ViewState["BinhLuan"] = dt;
            }
            return (DataTable)ViewState["BinhLuan"];
        }
        set { ViewState["BinhLuan"] = value; }
    }

    protected void Page_Load(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {
            string maMon = Request.QueryString["maMon"] ?? "CF01";
            lblMaMon.Text = "Mã món: " + maMon;
            lblTenMon.Text = "Tên món: Cà phê đen đá (demo)";

            // Thêm 1 vài bình luận mẫu
            DataTable dt = BinhLuanTable;
            dt.Rows.Add("Khách A", 5, "Rất ngon, sẽ quay lại!", DateTime.Now.AddDays(-1));
            dt.Rows.Add("Khách B", 4, "Ổn, giá hợp lý.", DateTime.Now.AddHours(-5));
            BinhLuanTable = dt;

            BindBinhLuan();
        }
    }

    private void BindBinhLuan()
    {
        gvBinhLuan.DataSource = BinhLuanTable;
        gvBinhLuan.DataBind();

        // Tính điểm trung bình
        DataTable dt = BinhLuanTable;
        if (dt.Rows.Count > 0)
        {
            double tong = 0;
            foreach (DataRow r in dt.Rows)
                tong += Convert.ToInt32(r["SoSao"]);
            double tb = tong / dt.Rows.Count;
            lblDiemTB.Text = "Điểm trung bình: " + tb.ToString("0.0") + " / 5";
        }
        else
        {
            lblDiemTB.Text = "Điểm trung bình: 0.0 / 5";
        }
    }

    protected void btnGui_Click(object sender, EventArgs e)
    {
        if (!Page.IsValid) return;

        DataTable dt = BinhLuanTable;
        dt.Rows.Add(
            txtTenKhach.Text.Trim(),
            int.Parse(rblSao.SelectedValue),
            txtNoiDung.Text.Trim(),
            DateTime.Now
        );
        BinhLuanTable = dt;

        txtTenKhach.Text = "";
        txtNoiDung.Text = "";
        rblSao.SelectedValue = "3";

        lblThongBao.Text = "Cảm ơn bạn đã đánh giá!";

        BindBinhLuan();
    }
}
